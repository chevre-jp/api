# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/).

## Unreleased

### Added

- 決済取引をCreditCardとMovieTicketに対応
- 劇場インターフェースにhasEntranceGateを追加
- イベントの部分更新エンドポイントを追加
- USE_AGGREGATE_ON_PROJECT設定を追加
- 返金取引を追加
- 返金タスクを追加

### Changed

- 取引タイプごとのタスクエクスポート処理を共通化
- 取引確定時のタスクエクスポート処理を追加
- イベント検索にprojectionを指定できるように調整
- 余分確保分座席が残席数に反映されるように集計処理を調整
- 予約作成時にイベントに対する予約集計処理を追加
- ttts対応として同時間帯のイベントについても同時に予約集計するように調整
- 作品検索のX-Total-Countヘッダーを削除

### Deprecated

### Removed

### Fixed

- イベントに含まれる不要な情報を検索結果から除外するように対応

### Security

## v7.28.1 - 2020-07-14

### Added

- 販売者ルーターを追加

## v7.28.0 - 2020-07-14

### Changed

- 決済取引を追加
- 販売者リポジトリを追加
- 販売者ルーターを追加

## v7.27.1 - 2020-07-12

### Changed

- イベントオファー検索処理を最適化

## v7.27.0 - 2020-07-09

### Changed

- オファーと価格仕様のappliesToMovieTicketTypeをappliesToMovieTicketに変更

## v7.26.0 - 2020-07-02

### Added

- 最大予約猶予期間設定を追加

### Removed

- 予約取引の予約追加エンドポイントを削除

## v7.25.0 - 2020-07-01

### Added

- プロダクト検索条件拡張

### Fixed

- イベント保管メソッドがパラメータ変数を上書きしてしまうバグ対応

## v7.24.2 - 2020-06-30

### Changed

- COAイベントキャパシティインポートタスク作成時に、未実行の古いタスクを中止するように調整

## v7.24.1 - 2020-06-30

### Added

- COA_MAXIMUM_CONCURRENT_TASKS設定を追加

### Changed

- update @chevre/domain
- update mongoose
- update express-validator
- COAイベントキャパシティインポート処理の実行間隔を調整

## v7.24.0 - 2020-06-27

### Changed

- サービス登録取引を取引番号で中止できるように調整

## v7.23.0 - 2020-06-25

### Changed

- サービスアウトプット検索条件拡張

## v7.22.0 - 2020-06-24

### Added

- プロダクトタイプにAccountを追加

## v7.21.0 - 2020-06-24

### Changed

- サービス登録時のサービスアウトプット識別子の指定を、プロダクトタイプに関わらず必須に変更

## v7.20.0 - 2020-06-24

### Added

- サービスアウトプット識別子ルーターを追加

## v7.19.0 - 2020-06-16

### Added

- サービス登録時にオファーのポイント特典を適用するように調整
- プロジェクト作成を追加

## v7.18.0 - 2020-06-11

### Changed

- サービス登録取引をメンバーシップサービスに対応

## v7.17.0 - 2020-05-30

### Added

- 予約番号での予約取消を追加

## v7.16.1 - 2020-05-27

### Changed

- トップデッキイベント作成処理調整

## v7.16.0 - 2020-05-27

### Changed

- COAイベントインポート処理をbulkWriteへ変更

## v7.15.0 - 2020-05-26

### Added

- 1トランザクションでの予約取消取引処理を追加

## v7.14.1 - 2020-05-26

### Changed

- COAイベントキャパシティインポート処理をbulkWriteへ変更

## v7.14.0 - 2020-05-26

### Changed

- COAイベントキャパシティインポート処理をbulkWriteへ変更

## v7.13.0 - 2020-05-25

### Added

- トップデッキイベント作成後に集計処理追加

## v7.12.1 - 2020-05-25

### Fixed

- 予約取消時のサブ予約取消処理を調整

## v7.12.0 - 2020-05-24

### Added

- 劇場に親組織を追加

## v7.11.1 - 2020-05-22

### Changed

- イベントのカタログ検索条件を調整

## v7.11.0 - 2020-05-22

### Added

- サービス登録取引を追加
- 通貨転送取引を追加
- 通貨転送取引番号リポジトリを追加
- DepositServiceを追加
- イベントにhasOfferCatalogを追加
- 取引番号発行サービスを追加
- トップデッキイベント作成タスクを追加

### Changed

- イベントのカタログ情報をoffersからhasOfferCatalogへ分離
- 取引ステータス変更時の複数タスク作成を一度に実行するように変更
- COA情報インポートタスクのエラーハンドリング調整
- 予約取引に取引番号を指定できるように調整
- 予約番号を取引番号として拡張
- 予約取引を取引番号で確定できるように調整
- 予約取引開始時に座席オファーを指定できるように調整

## v7.10.0 - 2020-04-26

### Added

- 定期COAオファーインポートタスクを追加

## v7.9.0 - 2020-04-24

### Added

- COAイベントインポートタスクを追加
- COAイベントキャパシティインポートタスクを追加
- プロジェクトにイベントインポート期間設定を追加

### Changed

- COAイベントインポート処理を調整
- タスク中止時の通知メッセージを調整

## v7.8.0 - 2020-04-16

### Added

- 劇場削除を追加

## v7.7.0 - 2020-04-15

### Added

- 予約にpreviousReservationStatusを追加

### Changed

- 発券カウントと入場カウント時に予約ステータスを条件に含めないように変更

## v7.6.0 - 2020-04-14

### Added

- プロジェクトごとの集計タスクを追加
- プロジェクトルーターを追加

### Fixed

- 座席のないイベントに対する座席を検索できないバグ対応

## v7.5.0 - 2020-04-13

### Added

- 劇場にPOS属性を追加

### Changed

- DeprecationWarning: collection.update is deprecated. -> updateMany
- mongoose.Schemaの汎用性を全体的に強化

## v7.4.0 - 2020-04-10

### Changed

- 座席有イベントかどうかの判断を最適化

## v7.3.0 - 2020-04-09

### Changed

- イベントの座席オファーのページング検索機能を追加

## v7.2.0 - 2020-04-08

### Added

- 予約取引に予約追加時に、レスポンスデータを受け取らない選択ができるように調整

## v7.1.0 - 2020-04-07

### Added

- スクリーン作成を追加
- スクリーン削除を追加
- 座席作成を追加
- 座席削除を追加
- スクリーンセクション管理を追加
- イベント固有のキャパシティ設定による在庫管理を実装

### Changed

- スクリーン検索条件拡張
- 座席検索条件拡張
- 場所コレクションインデックス調整
- MongoDB接続オプション調整
- Mongoose: the `safe` option -> writeConcerns

## v7.0.0 - 2020-03-30

### Added

- メンバーシッププログラムルーターを追加
- オファールーターを券種ルーターと分離
- オファーカタログルーターを券種グループルーターと分離
- 予約レポートサービスを追加
- プロダクトリポジトリを追加
- メンバーシップリポジトリを追加
- メンバーシップ登録取引サービスを追加
- カテゴリーコードリポジトリを追加
- カテゴリーコードチャージ仕様インターフェースを追加
- カテゴリーコードルーターを追加
- プロダクトサービスを追加
- オファーレート制限リポジトリを追加
- スクリーンルーターを追加
- 座席ルーターを追加
- オファーカタログリポジトリを追加
- 予約部分変更を追加

### Changed

- 予約検索結果のX-Total-Countを削除
- 各リソースの正規表現検索についてcase insensitivityを無効化
- 作品検索条件拡張
- 券種検索条件拡張
- 券種グループ検索条件拡張
- 勘定科目検索条件拡張
- イベントと作品以外のリソース検索からX-Total-Countを削除
- サービスタイプをカテゴリーコードに統合
- 配給区分をカテゴリーコードに統合
- 座席オファー情報に価格仕様を追加
- 予約の価格仕様インターフェースを拡張
- 予約にアドオンを指定できるように調整
- オファー適用条件拡張
- イベントのacceptedOfferを拡張
- イベント残席数集計を座席ロック数から計算するように調整
- 予約に余分確保分としてのsubReservationを追加
- オファーに適用サブ予約条件を追加
- 自由席許可属性を場所インターフェースに追加
- オファーに有効期間を追加
- イベントのオファー検索結果をカタログの登録順にソート
- 作品コレクションのインデックス調整
- ticketTypeGroupsをofferCatalogsへ移行
- subjectsをaccountTitlesへ移行
- 配給ルーターをカテゴリーコードルーターへ移行
- 券種検索条件をオファー検索条件に統合
- ticketTypesコレクションをoffersコレクションへ移行
- MongoDBコネクション監視調整

### Removed

- 興行区分サービスを削除
- 配給区分サービスを削除
- オファーカテゴリーサービスを削除

## v6.7.0 - 2019-12-25

### Changed

- ウェブフック通知にタイムアウトを設定

## v6.6.0 - 2019-12-06

### Changed

- 予約取引に仮予約が存在しない場合に、予約確定タスクが作成されないように調整
- 予約取引に仮予約が存在しない場合に、予約取消タスクが作成されないように調整

## v6.5.0 - 2019-11-19

### Added

- 予約検索条件を拡張

### Changed

- 予約のbookingTimeを仮予約時にセットするように調整

## v6.4.0 - 2019-11-19

### Changed

- 予約検索の予約日時期間指定を調整

## v6.3.0 - 2019-10-31

### Added

- イベント変更時処理を追加

## v6.2.0 - 2019-10-29

### Added

- プロジェクトリポジトリを追加
- 予約取消取引に予約ステータス変更時イベントを追加
- プロジェクトの予約通知設定を取引に反映

### Changed

- 取引開始時のagent指定を拡張

### Fixed

- URLの指定がない場合にウェブフックトリガー処理が正常終了しないバグ対応

## v6.1.0 - 2019-10-25

### Added

- 予約取引に予約ステータス変更時イベントを追加

## v6.0.0 - 2019-09-20

### Changed

- 予約取引の予約番号発行プロセスと仮予約プロセスを分離
- 予約データに不要なイベント属性について最適化

## v5.1.1 - 2019-09-03

### Fixed

- 予約が存在しない場合に保留中予約取消タスクが失敗しないように調整

## v5.1.0 - 2019-09-03

### Changed

- 予約確定アクションのポストアクションに予約通知アクションを追加
- 予約取消アクションのポストアクションに予約通知アクションを追加
- install @chevre/domain@11.x.x

## v5.0.1 - 2019-08-09

### Changed

- update mongoose

## v5.0.0 - 2019-07-29

### Changed

- [@chevre/domain](https://www.npmjs.com/package/@chevre/domain)で再構築
- 予約管理サービスとして再構築
